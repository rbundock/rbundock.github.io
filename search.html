<html>
<head>
    <script src="/js/underscore-min.js"></script>
    <script src="/js/backbone-min.js"></script>
    <script src="/js/lunr.min.js"></script>
</head>

<script>
    var Posts = Backbone.Collection.extend({
    url: '/data/posts.json', // when we fetch, we get the JSON data Jekyll built for us
    initialize: function() {

        // here we create the index for the posts collection
        this.index = lunr(function() {
            this.field('title', {boost: 10});
            this.field('categories', {boost: 5});
            this.field('excerpt');
            this.ref('id')
        });
    },
    parse: function(posts) {
        var self = this;

        _(posts).each(function(post) {

            // add post to the lunr index
            self.index.add(post);

            // break categories apart for easier rendering in the template
            post.categories = post.categories.replace(/\s+/g, '').split(',');
        });

        // return our modified posts array
        return posts;
    },
    filter: function(term) {
        var self = this;

        // lunr returns an array of objects, we map over them and replace the lunr ref with the actual model
        var results = _(this.index.search(term)).map(function(r) {
            return self.get(r.ref);
        });

        // return the matching models from our collection
        return results;
    }
    });
</script>
<body>
<form class="search-form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">Enter your search term...</label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
</form>

<script type="text/template" id="search-results">
    <div class="result">
      <h3><a href="<%= url %>"><%= title %></a></h3>
      <p><%= excerpt.substr(0, 120) + '...' %></p>
      <div class="categories">
        <% for (var i = 0; i < categories.length; i++) { %>
            <span class="category pill"><%= categories[i] %></span>
        <% } %>
      </div>
    </div>
</script>
</body>

<script>
    var SearchResult = Backbone.View.extend({
        initialize: function() {
            // Using vanilla JS to get the template content
            this.template = _.template(document.getElementById('search-results').innerHTML.trim());
        },
        render: function() {
            this.el.innerHTML = this.template(this.model.attributes);
            return this;
        }
    });

    var posts = new Posts();
    posts.fetch();

    // Use vanilla JS to add an event listener
    document.getElementById('search').addEventListener('change', function() {
        var results = posts.filter(this.value.trim());
        
        // Use vanilla JS to clear the container
        var resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';
        
        results.forEach(function(r) {
            // Append results to the container using vanilla JS
            resultsContainer.appendChild(new SearchResult({model: r}).render().el);
        });
    });
</script>

</html>