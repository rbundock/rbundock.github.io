<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Posts</title>
    <script src="/js/lunr.min.js"></script>
</head>
<body>
    <div>
        <label for="search">Enter your search term:</label>
        <input type="text" id="search">
        <!-- <button onclick="performSearch()">Search</button> -->
    </div>
    
    <div id="results"></div>

    <script>
        class Posts {
            constructor() {
                this.posts = [];
                this.index = null; // Initialize as null for now
                this.builder = new lunr.Builder();
                
                this.builder.pipeline.add(
                    lunr.trimmer,
                    lunr.stopWordFilter,
                    lunr.stemmer
                );

                this.builder.searchPipeline.add(
                    lunr.stemmer
                );

                this.builder.ref('id');
                this.builder.field('title', { boost: 10 });
                this.builder.field('categories', { boost: 5 });
                this.builder.field('excerpt');
            }

            fetch() {
                return new Promise((resolve, reject) => {
                    fetch('/data/posts.json')
                        .then(response => response.json())
                        .then(data => {
                            this.posts = this.parse(data);
                            this.posts.forEach(post => this.builder.add(post));
                            
                            // After all documents are added, build the index
                            this.index = this.builder.build();
                            
                            resolve(); // Resolve the promise
                        })
                        .catch(error => {
                            console.error("There was an error fetching the posts:", error);
                            reject(error); // Reject the promise
                        });
                });
            }

            parse(posts) {
                return posts.map(post => {
                    post.categories = post.categories.replace(/\s+/g, '').split(',');
                    return post;
                });
            }

            filter(term) {
                let results = this.index.search(term);
                return results.map(result => {
                    return this.posts.find(post => post.id === result.ref);
                });
            }
        }

        const myPosts = new Posts();
        myPosts.fetch();

        function performSearch() {
            const searchTerm = document.getElementById('search').value;
            const results = myPosts.filter(searchTerm);
            displayResults(results);
        }

        document.addEventListener('DOMContentLoaded', function() {
            myPosts.fetch().then(() => { // Wait for fetch to complete
                const initialQuery = getQueryParameter('q');
                
                if (initialQuery) {
                    document.getElementById('search').value = initialQuery;
                    performSearch();
                }

                document.getElementById('search').addEventListener('input', performSearch);
            }).catch(error => {
                console.error("There was an error initializing:", error);
            });
        });

        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function displayResults(posts) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            posts.forEach(post => {
                resultsDiv.innerHTML += `
                    <div>
                        <a href="${post.url}"><h3>${post.title}</h3></a>
                        <p>${post.excerpt}</p>
                        <p><strong>Categories:</strong> ${post.categories.join(', ')}</p>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
